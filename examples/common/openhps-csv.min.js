!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("@openhps/core")):"function"==typeof define&&define.amd?define("OpenHPS",["core"],t):"object"==typeof exports?exports.OpenHPS=t(require("@openhps/core")):(e.OpenHPS=e.OpenHPS||{},e.OpenHPS.csv=t(e.OpenHPS.core))}("undefined"!=typeof self?self:this,(e=>(()=>{var t={715:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CSVDataObjectService=void 0;const n=r(655),o=r(0),i=r(562),s=r(341),a=r(576);class CSVDataObjectService extends o.DataObjectService{constructor(e,t){super(new o.MemoryDataService(e)),this.options=t,this.once("build",this._initCSV.bind(this))}_initCSV(){return new Promise(((e,t)=>{if(!this.options.file)return e();this.parseStream(s.createReadStream(this.options.file)).then((e=>Promise.all(e.map(this.insertObject.bind(this))))).then((()=>{e()})).catch(t)}))}parseContent(e){const t=new a.Readable;return t.push(e),t.push(null),this.parseStream(t)}parseStream(e){return new Promise(((t,r)=>{const o=[];let s=0,a=0;const c=e.pipe(i(this.options)).on("data",(e=>n.__awaiter(this,void 0,void 0,(function*(){s++;const t=yield Promise.resolve(this.options.rowCallback(e));null!=t&&o.push(t),a++})))).on("end",(()=>{c.destroy()})).on("close",(function(e){if(e)return r(e);if(a!==s){const e=setInterval((()=>{a===s&&(clearInterval(e),t(o))}),100)}else t(o)}))}))}}t.CSVDataObjectService=CSVDataObjectService},40:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CSVDataSource=void 0;const n=r(655),o=r(0),i=r(420),s=r(341),a=r(562),c=r(576);class CSVDataSource extends o.ListSourceNode{constructor(e,t,r){super([],r),this.options.source=this.options.source||new o.DataObject(e?i.basename(e):void 0),this.rowCallback=t,this._file=e,this.once("build",this._initCSV.bind(this))}_initCSV(){return new Promise(((e,t)=>{if(!this._file)return e();this.parseStream(s.createReadStream(this._file)).then((t=>{this.inputData=t,e()})).catch(t)}))}parseContent(e){const t=new c.Readable;return t.push(e),t.push(null),this.parseStream(t)}parseStream(e){return new Promise(((t,r)=>{const o=[],i=e.pipe(a(this.options)).on("data",(e=>n.__awaiter(this,void 0,void 0,(function*(){const t=yield Promise.resolve(this.rowCallback(e));null!=t&&(void 0===t.source&&(t.source=this.source),o.push(t))})))).on("end",(()=>{i.destroy()})).on("close",(function(e){if(e)return r(e);t(o)}))}))}reload(e){return this._file=e,this.reset()}reset(){return new Promise(((e,t)=>{this.inputData=[],this._initCSV().then((()=>{e()})).catch((e=>{t(e)}))}))}}t.CSVDataSource=CSVDataSource},291:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(655);n.__exportStar(r(40),t),n.__exportStar(r(715),t)},562:(e,t,r)=>{const{Transform:n}=r(719),[o]=Buffer.from("\r"),[i]=Buffer.from("\n"),s={escape:'"',headers:null,mapHeaders:({header:e})=>e,mapValues:({value:e})=>e,newline:"\n",quote:'"',raw:!1,separator:",",skipComments:!1,skipLines:null,maxRowBytes:Number.MAX_SAFE_INTEGER,strict:!1};class CsvParser extends n{constructor(e={}){super({objectMode:!0,highWaterMark:16}),Array.isArray(e)&&(e={headers:e});const t=Object.assign({},s,e);t.customNewline=t.newline!==s.newline;for(const e of["newline","quote","separator"])void 0!==t[e]&&([t[e]]=Buffer.from(t[e]));t.escape=(e||{}).escape?Buffer.from(t.escape)[0]:t.quote,this.state={empty:t.raw?Buffer.alloc(0):"",escaped:!1,first:!0,lineNumber:0,previousEnd:0,rowLength:0,quoted:!1},this._prev=null,!1===t.headers&&(t.strict=!1),(t.headers||!1===t.headers)&&(this.state.first=!1),this.options=t,this.headers=t.headers}parseCell(e,t,r){const{escape:n,quote:o}=this.options;e[t]===o&&e[r-1]===o&&(t++,r--);let i=t;for(let s=t;s<r;s++)e[s]===n&&s+1<r&&e[s+1]===o&&s++,i!==s&&(e[i]=e[s]),i++;return this.parseValue(e,t,i)}parseLine(e,t,r){const{customNewline:n,escape:i,mapHeaders:s,mapValues:a,quote:c,separator:u,skipComments:l,skipLines:f}=this.options;r--,!n&&e.length&&e[r-1]===o&&r--;const p=u,h=[];let d=!1,y=t;if(l){const r="string"==typeof l?l:"#";if(e[t]===Buffer.from(r)[0])return}const v=e=>{if(this.state.first)return e;const t=h.length,r=this.headers[t];return a({header:r,index:t,value:e})};for(let n=t;n<r;n++){const t=!d&&e[n]===c,o=d&&e[n]===c&&n+1<=r&&e[n+1]===p,s=d&&e[n]===i&&n+1<r&&e[n+1]===c;if(t||o)d=!d;else if(s)n++;else if(e[n]===p&&!d){let t=this.parseCell(e,y,n);t=v(t),h.push(t),y=n+1}}if(y<r){let t=this.parseCell(e,y,r);t=v(t),h.push(t)}e[r-1]===p&&h.push(v(this.state.empty));const b=f&&f>this.state.lineNumber;if(this.state.lineNumber++,this.state.first&&!b)return this.state.first=!1,this.headers=h.map(((e,t)=>s({header:e,index:t}))),void this.emit("headers",this.headers);if(!b&&this.options.strict&&h.length!==this.headers.length){const e=new RangeError("Row length does not match headers");this.emit("error",e)}else b||this.writeRow(h)}parseValue(e,t,r){return this.options.raw?e.slice(t,r):e.toString("utf-8",t,r)}writeRow(e){const t=!1===this.headers?e.map(((e,t)=>t)):this.headers,r=e.reduce(((e,r,n)=>{const o=t[n];return null===o||(void 0!==o?e[o]=r:e[`_${n}`]=r),e}),{});this.push(r)}_flush(e){if(this.state.escaped||!this._prev)return e();this.parseLine(this._prev,this.state.previousEnd,this._prev.length+1),e()}_transform(e,t,r){"string"==typeof e&&(e=Buffer.from(e));const{escape:n,quote:s}=this.options;let a=0,c=e;this._prev&&(a=this._prev.length,c=Buffer.concat([this._prev,e]),this._prev=null);const u=c.length;for(let e=a;e<u;e++){const t=c[e],l=e+1<u?c[e+1]:null;if(this.state.rowLength++,this.state.rowLength>this.options.maxRowBytes)return r(new Error("Row exceeds the maximum size"));this.state.escaped||t!==n||l!==s||e===a?t!==s?this.state.quoted||(this.state.first&&!this.options.customNewline&&(t===i?this.options.newline=i:t===o&&l!==i&&(this.options.newline=o)),t===this.options.newline&&(this.parseLine(c,this.state.previousEnd,e+1),this.state.previousEnd=e+1,this.state.rowLength=0)):this.state.escaped?this.state.escaped=!1:this.state.quoted=!this.state.quoted:this.state.escaped=!0}return this.state.previousEnd===u?(this.state.previousEnd=0,r()):u-this.state.previousEnd<e.length?(this._prev=e,this.state.previousEnd-=u-e.length,r()):(this._prev=c,void r())}}e.exports=e=>new CsvParser(e)},655:(e,t,r)=>{"use strict";r.r(t),r.d(t,{__assign:()=>i,__asyncDelegator:()=>S,__asyncGenerator:()=>m,__asyncValues:()=>g,__await:()=>_,__awaiter:()=>l,__classPrivateFieldGet:()=>C,__classPrivateFieldIn:()=>R,__classPrivateFieldSet:()=>E,__createBinding:()=>p,__decorate:()=>a,__exportStar:()=>h,__extends:()=>o,__generator:()=>f,__importDefault:()=>x,__importStar:()=>j,__makeTemplateObject:()=>O,__metadata:()=>u,__param:()=>c,__read:()=>y,__rest:()=>s,__spread:()=>v,__spreadArray:()=>w,__spreadArrays:()=>b,__values:()=>d});var n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},n(e,t)};function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var i=function(){return i=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},i.apply(this,arguments)};function s(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(r[n[o]]=e[n[o]])}return r}function a(e,t,r,n){var o,i=arguments.length,s=i<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(i<3?o(s):i>3?o(t,r,s):o(t,r))||s);return i>3&&s&&Object.defineProperty(t,r,s),s}function c(e,t){return function(r,n){t(r,n,e)}}function u(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function l(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))}function f(e,t){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}var p=Object.create?function(e,t,r,n){void 0===n&&(n=r);var o=Object.getOwnPropertyDescriptor(t,r);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,o)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]};function h(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||p(t,e,r)}function d(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function y(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s}function v(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(y(arguments[t]));return e}function b(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var n=Array(e),o=0;for(t=0;t<r;t++)for(var i=arguments[t],s=0,a=i.length;s<a;s++,o++)n[o]=i[s];return n}function w(e,t,r){if(r||2===arguments.length)for(var n,o=0,i=t.length;o<i;o++)!n&&o in t||(n||(n=Array.prototype.slice.call(t,0,o)),n[o]=t[o]);return e.concat(n||Array.prototype.slice.call(t))}function _(e){return this instanceof _?(this.v=e,this):new _(e)}function m(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n,o=r.apply(e,t||[]),i=[];return n={},s("next"),s("throw"),s("return"),n[Symbol.asyncIterator]=function(){return this},n;function s(e){o[e]&&(n[e]=function(t){return new Promise((function(r,n){i.push([e,t,r,n])>1||a(e,t)}))})}function a(e,t){try{(r=o[e](t)).value instanceof _?Promise.resolve(r.value.v).then(c,u):l(i[0][2],r)}catch(e){l(i[0][3],e)}var r}function c(e){a("next",e)}function u(e){a("throw",e)}function l(e,t){e(t),i.shift(),i.length&&a(i[0][0],i[0][1])}}function S(e){var t,r;return t={},n("next"),n("throw",(function(e){throw e})),n("return"),t[Symbol.iterator]=function(){return this},t;function n(n,o){t[n]=e[n]?function(t){return(r=!r)?{value:_(e[n](t)),done:"return"===n}:o?o(t):t}:o}}function g(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,r=e[Symbol.asyncIterator];return r?r.call(e):(e=d(e),t={},n("next"),n("throw"),n("return"),t[Symbol.asyncIterator]=function(){return this},t);function n(r){t[r]=e[r]&&function(t){return new Promise((function(n,o){(function(e,t,r,n){Promise.resolve(n).then((function(t){e({value:t,done:r})}),t)})(n,o,(t=e[r](t)).done,t.value)}))}}}function O(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}var P=Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t};function j(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&p(t,e,r);return P(t,e),t}function x(e){return e&&e.__esModule?e:{default:e}}function C(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)}function E(e,t,r,n,o){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!o)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!o:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?o.call(e,r):o?o.value=r:t.set(e,r),r}function R(e,t){if(null===t||"object"!=typeof t&&"function"!=typeof t)throw new TypeError("Cannot use 'in' operator on non-object");return"function"==typeof e?t===e:e.has(t)}},0:t=>{"use strict";t.exports=e},341:()=>{},420:()=>{},576:()=>{},719:()=>{}},r={};function n(e){var o=r[e];if(void 0!==o)return o.exports;var i=r[e]={exports:{}};return t[e](i,i.exports,n),i.exports}return n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n(291)})()));
//# sourceMappingURL=openhps-csv.min.js.map